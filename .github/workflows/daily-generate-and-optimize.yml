name: Daily Generate & Optimize Coloring Pages

on:
  schedule:
    # Run at 5 AM EST = 10 AM UTC (EST is UTC-5)
    - cron: '0 10 * * *'
  workflow_dispatch:  # Allow manual trigger for testing

permissions:
  contents: write  # For pushing commits
  issues: write    # For posting comments on tracking issue

env:
  NODE_VERSION: '20'
  TRACKING_ISSUE_NUMBER: 1

jobs:
  generate:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        collection: [cats, dogs, horses, butterflies, sharks]
    
    steps:
      - name: Set daily style rotation key
        id: daily_key
        run: |
          DAILY_KEY=$(date -u +%F)
          echo "DAILY_STYLE_KEY=$DAILY_KEY" >> $GITHUB_ENV
          echo "Daily style key set to: $DAILY_KEY"
      
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create .dev.vars from GitHub Secrets
        run: |
          cat << 'EOF' > .dev.vars
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          R2_ACCOUNT_ID=${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID=${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY=${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME=${{ secrets.R2_BUCKET_NAME }}
          R2_PUBLIC_URL=${{ secrets.R2_PUBLIC_URL }}
          CF_IMAGES_ACCOUNT_ID=${{ secrets.CF_IMAGES_ACCOUNT_ID }}
          CF_IMAGES_API_TOKEN=${{ secrets.CF_IMAGES_API_TOKEN }}
          CF_IMAGES_ACCOUNT_HASH=${{ secrets.CF_IMAGES_ACCOUNT_HASH }}
          EOF

      - name: Generate ${{ matrix.collection }} (1 image)
        id: generate
        env:
          STYLE_MODE: rotate
          STYLE_ROTATION_KEY: ${{ env.DAILY_STYLE_KEY }}
        run: |
          RUN_ID=$(date +%Y-%m-%dT%H-%M-%SZ)-${{ matrix.collection }}
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          GENERATION_RUN_ID=$RUN_ID npx ts-node scripts/morning-routine/tasks/generate-batch.ts animals ${{ matrix.collection }} 1

      - name: Optimize SEO metadata for ${{ matrix.collection }}
        id: seo
        run: |
          MANIFEST_FILE="scripts/morning-routine/.runs/${{ steps.generate.outputs.run_id }}.json"
          if [ -f "$MANIFEST_FILE" ]; then
            npx ts-node scripts/morning-routine/tasks/seo-review-batch.ts animals ${{ matrix.collection }} --manifest "$MANIFEST_FILE"
          else
            echo "âš ï¸  No manifest found, skipping SEO for ${{ matrix.collection }}"
          fi
        continue-on-error: true

      - name: Validate no deprecated tags exist (guardrail)
        run: npm run validate:taxonomy

      - name: Stage newly generated files (this collection only)
        id: stage
        shell: bash
        run: |
          set -euo pipefail
          rm -rf staging
          mkdir -p staging

          # Copy only untracked files created during this job, under this collection
          # Uses -z (null terminator) to handle any filenames safely
          git ls-files -z --others --exclude-standard -- "content/animals/${{ matrix.collection }}/" \
            | xargs -0 -r cp --parents -t staging

          # Count files for conditional upload
          COUNT="$(find staging/content/animals/${{ matrix.collection }} -type f 2>/dev/null | wc -l | tr -d ' ')"
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"
          echo "Staged $COUNT file(s)"

      - name: Upload generated content as artifact
        if: steps.stage.outputs.count != '0'
        uses: actions/upload-artifact@v4
        with:
          name: content-${{ matrix.collection }}
          path: staging/
          retention-days: 1

  commit:
    needs: generate
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          # Download to root to restore preserved paths (content/animals/...)
          path: .
          pattern: content-*
          merge-multiple: true

      - name: Commit generated content
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add content/animals/
          
          if git diff --staged --quiet; then
            echo "âœ“ No changes to commit"
          else
            git commit -m "ðŸŽ¨ Generate daily coloring pages [automated]"
            git push
            echo "âœ“ Pushed changes"
          fi

      - name: Report workflow summary
        run: |
          echo "## ðŸŽ¨ Daily Generation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Generation completed for all collections. Check individual matrix jobs for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Schedule:** 5 AM EST (10 AM UTC)" >> $GITHUB_STEP_SUMMARY

      - name: Post status to tracking issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = ${{ env.TRACKING_ISSUE_NUMBER }};
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const timestamp = new Date().toISOString();
            
            const comment = `âœ… **DAILY WORKFLOW COMPLETE** â€” ${timestamp}\n\nAll collections processed. [View Run Details](${runUrl})`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: comment
            });
